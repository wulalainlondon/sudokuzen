<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=0">
    <title>Minimal Sudoku Pro - Elegant Zen Puzzle</title>
    <meta name="description"
        content="A clean, minimalist Sudoku game featuring a premium life system, dark mode, and zen design. Play Sudoku online with a professional interface.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sudoku Zen">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
    <style>
        :root[data-theme="light"] {
            --bg-color: #F8F9FA;
            --grid-bg: #FFFFFF;
            --cell-border: #D1D5DB;
            /* 加深格線顏色專注對比 */
            --block-border: #9CA3AF;
            /* 加深區域線顏色 */
            --text-main: #2D3436;
            --text-light: #636E72;
            --accent-soft: rgba(9, 132, 227, 0.08);
            /* 改為半透明確保格線透出 */
            --accent-strong: #0984E3;
            --note-color: #A29BFE;
            --error-color: #D63031;
            --btn-bg: #FFFFFF;
        }

        :root[data-theme="dark"] {
            --bg-color: #121212;
            --grid-bg: #1E1E1E;
            --cell-border: #374151;
            --block-border: #4B5563;
            --text-main: #E0E0E0;
            --text-light: #B0B0B0;
            --accent-soft: rgba(9, 132, 227, 0.15);
            /* 暗色模式高亮透明度調整 */
            --accent-strong: #4FACFE;
            --note-color: #B388FF;
            --error-color: #FF7675;
            --btn-bg: #2C2C2C;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            background-color: var(--bg-color);
            font-family: 'Outfit', 'Inter', sans-serif;
            color: var(--text-main);
            overflow: hidden;
            /* 防止整體滾動 */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        html {
            height: -webkit-fill-available;
        }

        .game-container {
            width: 100%;
            /* 將 max-width 稍微放寬，讓 min() 函數去決定實際大小 */
            max-width: 500px;
            height: 100dvh;
            /* 修改點：增加頂部動態間距 (2vh + 安全區域)，讓 Header 不要貼頂 */
            padding: calc(2vh + env(safe-area-inset-top)) 15px env(safe-area-inset-bottom);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }

        /* 頂部 Header：標題在左，Quit 在右 */
        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2vh;
            /* 與下方內容保持距離 */
        }

        /* 去掉原本 header 內的舊佈局，讓它變簡單 */
        header h1 {
            font-size: 1.1rem;
            font-weight: 300;
            letter-spacing: 2px;
            margin: 0;
        }

        /* Quit 按鈕移動到最右上角，風格更輕盈 */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .header-btn:active {
            transform: scale(0.9);
        }

        .quit-btn {
            padding: 6px 14px;
            font-size: 0.75rem;
            border: 1px solid var(--cell-border);
            background: var(--btn-bg);
            color: var(--text-light);
            border-radius: 20px;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 0;
        }

        .quit-btn:active {
            transform: scale(0.95);
            background: var(--accent-soft);
        }

        /* 關鍵修正：資訊列與數獨格同寬，並左右對齊 */
        .grid-info-bar {
            /* 必須與 .sudoku-grid 的寬度計算法完全一致 */
            width: min(100%, calc(100vw - 30px), 42vh);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 8px;
            /* 緊貼在格子上方 */
        }

        .grid-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mini-btn {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid var(--cell-border);
            background: var(--btn-bg);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .mini-btn.alt {
            background: transparent;
            border-color: color-mix(in srgb, var(--cell-border) 70%, transparent);
        }

        .mini-btn svg {
            width: 18px;
            height: 18px;
        }

        .mini-btn.active {
            background: var(--accent-strong);
            color: #fff;
            border-color: var(--accent-strong);
            box-shadow: 0 4px 10px rgba(9, 132, 227, 0.25);
        }

        /* 計時器與關卡名 (左上) */
        .grid-info-bar .stats {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 400;
            margin: 0;
        }

        /* 生命值 ✖ ✖ ✖ (右上) */
        .grid-info-bar .life-container {
            font-size: 1rem;
            letter-spacing: 3px;
            /* 稍微縮小間隔，看起來更優雅 */
            line-height: 1;
            color: var(--error-color);
        }

        .life-container span.lost {
            color: var(--cell-border);
        }

        /* 網格與格子 */
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            background-color: var(--grid-bg);
            border: 2px solid var(--block-border);
            border-radius: 12px;
            overflow: hidden;

            /* 寬度限制：max 55dvh，防止垂直擠壓 */
            width: min(100%, 55vh);
            width: min(100%, 55dvh);
            aspect-ratio: 1 / 1;

            margin: 0 auto;
            flex-shrink: 0;
            user-select: none;
        }

        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            /* 使用 vw (視窗寬度單位) 讓字體隨螢幕寬度縮放 */
            font-size: min(5.5vw, 24px);
            font-weight: 300;
            border: 0.5px solid var(--cell-border);
            cursor: pointer;
            position: relative;
            background: var(--grid-bg);
            /* 確保文字不換行 */
            white-space: nowrap;
            overflow: hidden;
        }

        .cell:nth-child(3n) {
            border-right: 2px solid var(--block-border);
        }

        .cell:nth-child(9n) {
            border-right: none;
        }

        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid var(--block-border);
        }

        .cell.related {
            background-color: var(--accent-soft);
        }

        .cell.match {
            background-color: rgba(9, 132, 227, 0.25);
            /* 較深的高亮色以區分關聯格 */
            font-weight: 600;
            /* 讓數字更亮眼 */
        }

        .cell.selected {
            background-color: var(--accent-soft);
            outline: 2px inset var(--accent-strong);
            z-index: 1;
        }

        .cell.fixed {
            color: var(--text-main);
            font-weight: 600;
        }

        .cell.user-val {
            color: var(--accent-strong);
        }

        .cell.error {
            color: var(--error-color) !important;
            animation: shake 0.4s ease;
        }

        .cell.error-strong {
            background: rgba(214, 48, 49, 0.18) !important;
            outline: 2px solid var(--error-color);
            z-index: 2;
            animation: wrongPulse 0.6s ease;
        }

        .cell.error-peer {
            background: rgba(214, 48, 49, 0.1) !important;
        }

        .cell.wrong-preview {
            color: var(--error-color) !important;
            font-weight: 600;
            opacity: 0.9;
        }

        .cell.unit-complete {
            animation: unitCompletePop 0.55s ease;
            box-shadow: inset 0 0 0 1px rgba(9, 132, 227, 0.35);
        }

        @keyframes unitCompletePop {
            0% {
                transform: scale(1);
                background-color: rgba(9, 132, 227, 0.05);
            }

            35% {
                transform: scale(1.08);
                background-color: rgba(9, 132, 227, 0.22);
            }

            100% {
                transform: scale(1);
                background-color: inherit;
            }
        }

        @keyframes wrongPulse {
            0% {
                transform: scale(1);
            }

            35% {
                transform: scale(1.08);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes lifeHit {
            0% {
                transform: translateX(0) scale(1);
            }

            25% {
                transform: translateX(-3px) scale(1.08);
            }

            50% {
                transform: translateX(3px) scale(1.08);
            }

            100% {
                transform: translateX(0) scale(1);
            }
        }

        .life-container.hit {
            animation: lifeHit 0.45s ease;
        }

        #feedback-toast {
            position: fixed;
            left: 50%;
            bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateX(-50%) translateY(10px);
            background: rgba(214, 48, 49, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            opacity: 0;
            pointer-events: none;
            z-index: 300;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        #feedback-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* 遊戲、暫停結束遮罩 */
        #overlay,
        #pause-screen,
        #win-celebration {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 12px;
            text-align: center;
        }

        #overlay h2,
        #pause-screen h2,
        #win-celebration h2 {
            font-weight: 300;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }

        #pause-screen p {
            font-size: 1.2rem;
            color: var(--accent-strong);
            margin-bottom: 30px;
        }

        .leaderboard-card {
            width: min(88%, 320px);
            margin-top: 6px;
            margin-bottom: 10px;
            border: 1px solid var(--cell-border);
            border-radius: 12px;
            padding: 10px 12px;
            background: var(--grid-bg);
            text-align: left;
        }

        .leaderboard-title {
            font-size: 0.78rem;
            color: var(--text-light);
            margin-bottom: 6px;
            letter-spacing: 0.6px;
        }

        .leaderboard-list {
            font-size: 0.78rem;
            line-height: 1.5;
        }

        #replay-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 400;
            padding: 20px;
        }

        .replay-panel {
            width: min(92vw, 420px);
            max-height: min(80vh, 680px);
            background: var(--grid-bg);
            border: 1px solid var(--cell-border);
            border-radius: 14px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .replay-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.8px;
        }

        .replay-summary {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .replay-list {
            border: 1px solid var(--cell-border);
            border-radius: 10px;
            padding: 8px 10px;
            overflow: auto;
            height: min(55vh, 420px);
            font-size: 0.82rem;
            line-height: 1.5;
            background: var(--btn-bg);
        }

        .replay-item {
            border-bottom: 1px dashed var(--cell-border);
            padding: 5px 0;
        }

        .replay-item:last-child {
            border-bottom: none;
        }

        .replay-time {
            color: var(--accent-strong);
            margin-right: 6px;
            font-weight: 600;
        }

        .replay-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .replay-filter-btn {
            border: 1px solid var(--cell-border);
            background: var(--btn-bg);
            color: var(--text-light);
            border-radius: 999px;
            padding: 5px 10px;
            font-size: 0.74rem;
            cursor: pointer;
        }

        .replay-filter-btn.active {
            color: #fff;
            background: var(--accent-strong);
            border-color: var(--accent-strong);
        }

        #win-celebration {
            z-index: 30;
            background: radial-gradient(circle at top, rgba(9, 132, 227, 0.16), var(--bg-color) 60%);
            overflow: hidden;
        }

        #win-celebration p {
            margin: 8px 0;
            color: var(--text-light);
        }

        #win-celebration .win-time {
            font-size: 1.2rem;
            color: var(--accent-strong);
            font-weight: 600;
        }

        #win-celebration .win-stars {
            font-size: 1.4rem;
            letter-spacing: 4px;
            color: #F1C40F;
            margin-bottom: 16px;
        }

        .confetti-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 12px;
            opacity: 0.85;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-20px) rotate(0deg);
                opacity: 0.95;
            }

            100% {
                transform: translateY(110vh) rotate(680deg);
                opacity: 0.1;
            }
        }

        .retry-btn,
        .back-btn,
        .resume-btn {
            margin-top: 15px;
            padding: 10px 30px;
            border: 1px solid var(--text-main);
            background: none;
            color: var(--text-main);
            cursor: pointer;
            border-radius: 20px;
            width: 180px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s;
        }

        .resume-btn {
            background: var(--accent-strong);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(9, 132, 227, 0.3);
        }

        /* Level Selector Redesign */
        #level-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: calc(20px + env(safe-area-inset-top)) 20px calc(20px + env(safe-area-inset-bottom));
            transition: opacity 0.4s;
        }

        .tabs-container {
            display: flex;
            gap: 6px;
            margin-bottom: 30px;
            background: var(--grid-bg);
            padding: 5px;
            border-radius: 25px;
            border: 1px solid var(--cell-border);
            width: 100%;
            max-width: 400px;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            min-width: 65px;
            padding: 10px 5px;
            border: none;
            background: none;
            color: var(--text-light);
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: var(--accent-strong);
            color: white;
            box-shadow: 0 4px 12px rgba(9, 132, 227, 0.3);
        }

        .alias-config {
            width: 100%;
            max-width: 400px;
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: -10px;
            margin-bottom: 16px;
        }

        .alias-input {
            flex: 1;
            border: 1px solid var(--cell-border);
            border-radius: 10px;
            background: var(--grid-bg);
            color: var(--text-main);
            padding: 8px 10px;
            font-size: 0.82rem;
            outline: none;
        }

        .alias-input:focus {
            border-color: var(--accent-strong);
            box-shadow: 0 0 0 2px var(--accent-soft);
        }

        .alias-save-btn {
            border: 1px solid var(--cell-border);
            border-radius: 10px;
            background: var(--btn-bg);
            color: var(--text-main);
            padding: 8px 12px;
            font-size: 0.78rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .version-badge {
            position: fixed;
            right: 10px;
            bottom: 10px;
            font-size: 0.68rem;
            letter-spacing: 0.6px;
            color: var(--text-light);
            background: color-mix(in srgb, var(--btn-bg) 70%, transparent);
            border: 1px solid color-mix(in srgb, var(--cell-border) 70%, transparent);
            border-radius: 999px;
            padding: 4px 8px;
            z-index: 50;
            pointer-events: none;
        }

        #level-list {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 400px;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 40px;
            scroll-behavior: smooth;
        }

        .level-item {
            aspect-ratio: 1/1;
            background: var(--grid-bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--cell-border);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s, border-color 0.2s;
        }

        .level-item:active {
            transform: scale(0.92);
        }

        .level-item.completed {
            border-color: var(--accent-strong);
            background: var(--accent-soft);
        }

        .level-num {
            font-size: 0.72rem;
            font-weight: 500;
            text-align: center;
        }

        .level-stats {
            font-size: 0.7rem;
            color: var(--text-light);
        }

        .level-stars {
            font-size: 0.75rem;
            color: #F1C40F;
            /* 金色星星 */
            margin-top: 2px;
        }

        .level-stars .empty-star {
            color: var(--cell-border);
        }

        /* Scrollbar styling */
        #level-list::-webkit-scrollbar {
            width: 4px;
        }

        #level-list::-webkit-scrollbar-thumb {
            background: var(--block-border);
            border-radius: 10px;
        }

        /* 控制區 */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: min(88vw, 320px);
            margin-top: auto;
            margin-bottom: 6px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        .num-btn {
            aspect-ratio: 1/1;
            border: 1px solid color-mix(in srgb, var(--cell-border) 82%, transparent);
            background:
                radial-gradient(circle at 28% 18%, rgba(255, 255, 255, 0.48), transparent 45%),
                linear-gradient(180deg, color-mix(in srgb, var(--btn-bg) 98%, #ffffff 2%), color-mix(in srgb, var(--btn-bg) 92%, var(--bg-color)));
            font-size: min(6.2vw, 1.35rem);
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            border-radius: 16px;
            box-shadow:
                0 4px 10px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.58);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            transition: transform 0.15s ease, opacity 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .num-btn::after {
            content: "";
            position: absolute;
            left: 8px;
            right: 8px;
            bottom: 6px;
            height: 4px;
            background: var(--accent-strong);
            transform: scaleX(0);
            transform-origin: left;
            opacity: 0.95;
            border-radius: 999px;
        }

        .num-btn.long-pressing::after {
            animation: holdFill 320ms linear forwards;
        }

        .num-btn:active {
            transform: translateY(1px) scale(0.97);
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        @media (hover: hover) and (pointer: fine) {
            .num-btn:hover {
                transform: translateY(-1px);
                border-color: color-mix(in srgb, var(--accent-strong) 45%, var(--cell-border));
                box-shadow:
                    0 9px 16px rgba(0, 0, 0, 0.09),
                    inset 0 1px 0 rgba(255, 255, 255, 0.45);
            }
        }

        .num-btn.completed {
            opacity: 0.42;
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--cell-border) 60%, transparent);
            border-color: color-mix(in srgb, var(--cell-border) 75%, transparent);
        }

        .num-btn.completed::after {
            display: none;
        }

        @media (max-height: 780px) {
            .numpad {
                gap: 6px;
                width: min(86vw, 300px);
            }

            .num-btn {
                font-size: min(5.8vw, 1.2rem);
                border-radius: 14px;
            }
        }

        @keyframes holdFill {
            from {
                transform: scaleX(0);
            }

            to {
                transform: scaleX(1);
            }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 35px;
            margin-top: 0;
            padding-bottom: 0;
        }

        .ctrl-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ctrl-btn.active {
            color: var(--accent-strong);
        }

        .ctrl-btn svg {
            width: 22px;
            height: 22px;
            margin-bottom: 6px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 0;
            pointer-events: none;
        }

        .note-num {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.55rem;
            line-height: 1;
            color: var(--note-color);
            opacity: 0;
        }

        .note-num.active {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div id="level-screen">
        <h1 style="margin-bottom: 25px; font-weight: 300; letter-spacing: 5px; font-family: 'Outfit';">SUDOKU ZEN</h1>
        <div class="alias-config">
            <input id="alias-input" class="alias-input" type="text" maxlength="24" placeholder="輸入你的暱稱（1~24字）" />
            <button class="alias-save-btn" onclick="saveAlias()">儲存暱稱</button>
        </div>
        <div class="tabs-container">
            <button class="tab-btn" onclick="switchTab(0)">初心者</button>
            <button class="tab-btn" onclick="switchTab(1)">禪</button>
            <button class="tab-btn" onclick="switchTab(2)">虛空</button>
            <button class="tab-btn" onclick="switchTab(3)">無我</button>
            <button class="tab-btn" onclick="switchTab(4)">本源</button>
            <button class="tab-btn" onclick="switchTab(5)">寂滅</button>
            <button class="tab-btn" onclick="switchTab(6)">空鏡</button>
            <button class="tab-btn" onclick="switchTab(7)">星潮</button>
            <button class="tab-btn" onclick="switchTab(8)">玄鏈</button>
        </div>
        <div id="level-list"></div>
        <div class="version-badge" id="version-badge">v--</div>
    </div>

    <div class="game-container">
        <div id="overlay">
            <h2>GAME OVER</h2>
            <p>你犯了 3 次錯誤</p>
            <button class="retry-btn" onclick="resetGame()">重新開始</button>
            <button class="back-btn" onclick="showLevelScreen()">返回選關</button>
        </div>

        <div id="pause-screen">
            <h2 id="pause-level-name">LEVEL NAME</h2>
            <p id="pause-timer">00:00</p>
            <div class="leaderboard-card">
                <div class="leaderboard-title">首通榜 TOP 3</div>
                <div class="leaderboard-list" id="leaderboard-list">載入中...</div>
            </div>
            <button class="resume-btn" onclick="resumeGame()">繼續遊戲</button>
            <button class="back-btn" style="border: none; font-size: 0.8rem; color: var(--text-light);"
                onclick="showLevelScreen()">放棄關卡</button>
        </div>

        <div id="win-celebration">
            <div class="confetti-layer" id="confetti-layer"></div>
            <h2>PERFECT FLOW</h2>
            <p id="win-level-name">LEVEL NAME</p>
            <div class="win-stars" id="win-stars">★★★</div>
            <p class="win-time" id="win-time">00:00</p>
            <div class="leaderboard-card">
                <div class="leaderboard-title">首通榜 TOP 3</div>
                <div class="leaderboard-list" id="win-leaderboard-list">載入中...</div>
            </div>
            <button class="back-btn" style="border-color: var(--accent-strong);" onclick="openReplayModal()">查看回放</button>
            <button class="resume-btn" onclick="showLevelScreen()">下一關</button>
            <button class="back-btn" style="border: none; font-size: 0.8rem; color: var(--text-light);"
                onclick="showLevelScreen()">返回選關</button>
        </div>

        <!-- 1. 頂部標題與 Quit 按鈕 -->
        <header>
            <h1>SUDOKU</h1>
            <div class="header-controls">
                <button class="header-btn" onclick="pauseGame()" aria-label="Pause Game">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                </button>
                <button class="quit-btn" onclick="showLevelScreen()">Quit</button>
            </div>
        </header>

        <!-- 2. 數獨格上方資訊列 (對齊格子的左右兩端) -->
        <div class="grid-info-bar">
            <div class="stats" id="timer">ZEN / 00:00</div>
            <div class="grid-right">
                <div class="grid-actions">
                    <button class="mini-btn alt" onclick="toggleTheme()" aria-label="Toggle Theme">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5" />
                            <path
                                d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                        </svg>
                    </button>
                    <button class="mini-btn" id="note-toggle" onclick="toggleNoteMode()" aria-label="Toggle Notes">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                            <path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                    </button>
                <button class="mini-btn" onclick="erase()" aria-label="Erase">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                </button>
            </div>
            <div class="life-container" id="lives"></div>
        </div>
    </div>

        <!-- 3. 數獨主網格 -->
        <div class="sudoku-grid" id="grid"></div>

        <div class="numpad" id="numpad"></div>

    <div class="controls">
    </div>
    </div>

    <div id="replay-modal">
        <div class="replay-panel">
            <h3 class="replay-title">本局步驟回放</h3>
            <div class="replay-summary" id="replay-summary">-</div>
            <div class="replay-filters">
                <button id="replay-filter-all" class="replay-filter-btn active" onclick="setReplayFilter('all')">全部</button>
                <button id="replay-filter-mistake" class="replay-filter-btn" onclick="setReplayFilter('mistake')">只看錯誤</button>
                <button id="replay-filter-key" class="replay-filter-btn" onclick="setReplayFilter('key')">只看關鍵步</button>
            </div>
            <div class="replay-list" id="replay-list"></div>
            <button class="resume-btn" onclick="closeReplayModal()">關閉</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="levels.js"></script>
    <script>
        const gridEl = document.getElementById('grid');
        const livesEl = document.getElementById('lives');
        const overlay = document.getElementById('overlay');
        const timerEl = document.getElementById('timer');
        const winCelebrationEl = document.getElementById('win-celebration');
        const confettiLayerEl = document.getElementById('confetti-layer');
        const leaderboardListEl = document.getElementById('leaderboard-list');
        const winLeaderboardListEl = document.getElementById('win-leaderboard-list');
        const aliasInputEl = document.getElementById('alias-input');
        const replayModalEl = document.getElementById('replay-modal');
        const replaySummaryEl = document.getElementById('replay-summary');
        const replayListEl = document.getElementById('replay-list');
        const replayFilterAllBtn = document.getElementById('replay-filter-all');
        const replayFilterMistakeBtn = document.getElementById('replay-filter-mistake');
        const replayFilterKeyBtn = document.getElementById('replay-filter-key');
        let feedbackTimer = null;
        let db = null;
        let firebaseReady = false;
        const ALIAS_MIN_LEN = 1;
        const ALIAS_MAX_LEN = 24;

        const feedbackToast = document.createElement('div');
        feedbackToast.id = 'feedback-toast';
        document.body.appendChild(feedbackToast);

        let selectedIdx = null;
        let isNotesMode = false;
        let errors = 0;
        const maxErrors = 3;
        let seconds = 0;
        let timerInterval = null;
        let currentLevel = null;

        let cellsData = [];
        let actionHistory = [];
        let replayFilter = 'all';
        let numButtons = [];

        function normalizeAlias(raw) {
            if (typeof raw !== 'string') return '';
            return raw.trim().slice(0, ALIAS_MAX_LEN);
        }

        function loadAliasToInput() {
            if (!aliasInputEl) return;
            const saved = localStorage.getItem('sudoku_player_alias') || '';
            aliasInputEl.value = saved;
        }

        function saveAlias() {
            const alias = normalizeAlias(aliasInputEl ? aliasInputEl.value : '');
            if (alias.length < ALIAS_MIN_LEN) {
                showFeedback('暱稱至少 1 個字');
                return;
            }
            localStorage.setItem('sudoku_player_alias', alias);
            if (aliasInputEl) aliasInputEl.value = alias;
            showFeedback(`暱稱已更新：${alias}`);
        }

        function getPlayerIdentity() {
            let playerId = localStorage.getItem('sudoku_player_id');
            if (!playerId) {
                playerId = `p_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
                localStorage.setItem('sudoku_player_id', playerId);
            }
            let alias = localStorage.getItem('sudoku_player_alias');
            if (!alias) {
                alias = `玩家${Math.floor(Math.random() * 9000) + 1000}`;
                localStorage.setItem('sudoku_player_alias', alias);
            }
            alias = normalizeAlias(alias);
            if (alias.length < ALIAS_MIN_LEN) alias = `玩家${Math.floor(Math.random() * 9000) + 1000}`;
            localStorage.setItem('sudoku_player_alias', alias);
            return { playerId, alias };
        }

        function initFirebase() {
            try {
                if (!window.firebase || !window.SUDOKU_FIREBASE_CONFIG) return;
                if (!firebase.apps.length) firebase.initializeApp(window.SUDOKU_FIREBASE_CONFIG);
                db = firebase.firestore();
                firebaseReady = true;
            } catch (e) {
                console.warn('Firebase init failed:', e);
            }
        }

        function formatSeconds(sec) {
            const mins = Math.floor(sec / 60).toString().padStart(2, '0');
            const secs = (sec % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function cellLabel(idx) {
            const r = Math.floor(idx / 9) + 1;
            const c = (idx % 9) + 1;
            return `R${r}C${c}`;
        }

        function recordAction(type, detail) {
            actionHistory.push({
                t: seconds,
                type,
                detail
            });
            if (actionHistory.length > 1200) actionHistory.shift();
        }

        function isKeyReplayAction(a) {
            return ['fill', 'mistake', 'quick_note'].includes(a.type);
        }

        function getFilteredReplayActions() {
            if (replayFilter === 'mistake') return actionHistory.filter(a => a.type === 'mistake');
            if (replayFilter === 'key') return actionHistory.filter(isKeyReplayAction);
            return actionHistory;
        }

        function syncReplayFilterButtons() {
            if (!replayFilterAllBtn) return;
            replayFilterAllBtn.classList.toggle('active', replayFilter === 'all');
            replayFilterMistakeBtn.classList.toggle('active', replayFilter === 'mistake');
            replayFilterKeyBtn.classList.toggle('active', replayFilter === 'key');
        }

        function setReplayFilter(filterKey) {
            replayFilter = filterKey;
            syncReplayFilterButtons();
            renderReplayList();
        }

        function renderReplayList() {
            const filtered = getFilteredReplayActions();
            const filterLabel =
                replayFilter === 'mistake' ? '錯誤步驟' :
                    replayFilter === 'key' ? '關鍵步驟' : '全部步驟';
            replaySummaryEl.textContent =
                `${currentLevel.displayName} / 用時 ${formatSeconds(seconds)} / ${filterLabel} ${filtered.length}/${actionHistory.length}`;

            if (!filtered.length) {
                replayListEl.innerHTML = '<div class="replay-item">此篩選下暫無步驟</div>';
                return;
            }
            replayListEl.innerHTML = filtered.map((a, i) => (
                `<div class="replay-item"><span class="replay-time">${formatSeconds(a.t)}</span>#${i + 1} ${a.detail}</div>`
            )).join('');
        }

        function openReplayModal() {
            if (!replayModalEl) return;
            replayFilter = 'all';
            syncReplayFilterButtons();
            renderReplayList();
            replayModalEl.style.display = 'flex';
        }

        function closeReplayModal() {
            if (!replayModalEl) return;
            replayModalEl.style.display = 'none';
        }

        function renderLeaderboard(el, rows) {
            if (!el) return;
            if (!firebaseReady) {
                el.textContent = '尚未啟用 Firebase 排行。';
                return;
            }
            if (!rows.length) {
                el.textContent = '尚無玩家首通紀錄';
                return;
            }
            el.innerHTML = rows.map((r, i) =>
                `${i + 1}. ${r.alias}  ${formatSeconds(r.firstTimeSec)}  ${'★'.repeat(r.firstStars)}`
            ).join('<br>');
        }

        async function loadLevelLeaderboard(levelId) {
            if (!firebaseReady) {
                renderLeaderboard(leaderboardListEl, []);
                renderLeaderboard(winLeaderboardListEl, []);
                return;
            }
            try {
                const snap = await db.collection('level_first_clears')
                    .doc(String(levelId))
                    .collection('players')
                    .orderBy('firstTimeSec', 'asc')
                    .limit(3)
                    .get();
                const rows = snap.docs.map(d => d.data());
                renderLeaderboard(leaderboardListEl, rows);
                renderLeaderboard(winLeaderboardListEl, rows);
            } catch (e) {
                console.warn('load leaderboard failed:', e);
                renderLeaderboard(leaderboardListEl, []);
                renderLeaderboard(winLeaderboardListEl, []);
            }
        }

        async function submitFirstClear(levelId, clearSec, clearStars) {
            if (!firebaseReady) return;
            const { playerId, alias } = getPlayerIdentity();
            const docRef = db.collection('level_first_clears')
                .doc(String(levelId))
                .collection('players')
                .doc(playerId);
            try {
                await db.runTransaction(async (tx) => {
                    const doc = await tx.get(docRef);
                    if (doc.exists) return;
                    tx.set(docRef, {
                        playerId,
                        alias,
                        firstTimeSec: clearSec,
                        firstStars: clearStars,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                });
            } catch (e) {
                console.warn('submit first clear failed:', e);
            }
        }

        function startTimer(reset = true) {
            clearInterval(timerInterval);
            if (reset) seconds = 0;
            updateTimerUI();
            timerInterval = setInterval(() => {
                seconds++;
                updateTimerUI();
            }, 1000);
        }

        function pauseGame() {
            clearInterval(timerInterval);
            const pauseScreen = document.getElementById('pause-screen');
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');

            document.getElementById('pause-level-name').textContent = currentLevel.displayName;
            document.getElementById('pause-timer').textContent = `${mins}:${secs}`;
            loadLevelLeaderboard(currentLevel.id);
            pauseScreen.style.display = 'flex';
        }

        function resumeGame() {
            document.getElementById('pause-screen').style.display = 'none';
            startTimer(false);
        }

        function updateTimerUI() {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            timerEl.textContent = `${currentLevel.displayName} / ${mins}:${secs}`;
        }

        function initGame(levelId = 1, forceReset = false) {
            currentLevel = levels.find(l => l.id === levelId) || levels[0];
            closeReplayModal();

            // 嘗試載入存檔
            const saved = forceReset ? null : loadGameStatus(currentLevel.id);

            if (saved) {
                cellsData = saved.cellsData;
                seconds = saved.seconds;
                errors = saved.errors;
                actionHistory = Array.isArray(saved.actionHistory) ? saved.actionHistory : [];
            } else {
                errors = 0;
                seconds = 0;
                actionHistory = [];
                cellsData = currentLevel.puzzle.map((val, idx) => ({
                    value: val,
                    fixed: val !== 0,
                    notes: [],
                    isError: false
                }));
            }

            updateLivesUI();
            overlay.style.display = 'none';
            document.getElementById('pause-screen').style.display = 'none';
            winCelebrationEl.style.display = 'none';
            renderGrid();
            startTimer(false); // 不重置，使用當前 seconds
            loadLevelLeaderboard(currentLevel.id);

            // Switch view
            document.getElementById('level-screen').style.display = 'none';
            document.querySelector('.game-container').style.display = 'flex';
        }

        function saveGameStatus() {
            if (!currentLevel) return;
            const data = {
                levelId: currentLevel.id,
                cellsData: cellsData,
                seconds: seconds,
                errors: errors,
                actionHistory: actionHistory
            };
            localStorage.setItem(`sudoku_save_${currentLevel.id}`, JSON.stringify(data));
        }

        function loadGameStatus(levelId) {
            const saved = localStorage.getItem(`sudoku_save_${levelId}`);
            return saved ? JSON.parse(saved) : null;
        }

        function clearGameStatus(levelId) {
            localStorage.removeItem(`sudoku_save_${levelId}`);
        }

        function renderGrid() {
            gridEl.innerHTML = '';
            cellsData.forEach((data, i) => {
                const cell = document.createElement('div');
                cell.className = `cell ${data.fixed ? 'fixed' : ''} ${data.isError ? 'error' : ''}`;
                updateCellDisplay(cell, data);
                cell.onclick = () => selectCell(i);
                gridEl.appendChild(cell);
            });
            updateNumpadState();
        }

        function updateCellDisplay(cell, data) {
            cell.innerHTML = '';
            if (data.value !== 0) {
                cell.textContent = data.value;
                if (!data.fixed) cell.classList.add('user-val');
                else cell.classList.remove('user-val');
            } else {
                const ng = document.createElement('div');
                ng.className = 'notes-grid';
                for (let n = 1; n <= 9; n++) {
                    const nd = document.createElement('div');
                    nd.className = `note-num ${data.notes.includes(n) ? 'active' : ''}`;
                    nd.textContent = n;
                    ng.appendChild(nd);
                }
                cell.appendChild(ng);
            }
        }

        function showFeedback(msg) {
            clearTimeout(feedbackTimer);
            feedbackToast.textContent = msg;
            feedbackToast.classList.add('show');
            feedbackTimer = setTimeout(() => {
                feedbackToast.classList.remove('show');
            }, 900);
        }

        function playErrorFeedback() {
            if (navigator.vibrate) navigator.vibrate(120);
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                const ctx = new AudioCtx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = 180;
                gain.gain.value = 0.03;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.08);
                setTimeout(() => ctx.close(), 150);
            } catch (_) {
                // Ignore audio errors silently.
            }
        }

        function markErrorArea(idx) {
            const row = Math.floor(idx / 9), col = idx % 9;
            const box = Math.floor(row / 3) * 3 + Math.floor(col / 3);
            Array.from(gridEl.children).forEach((c, i) => {
                const r = Math.floor(i / 9), cc = i % 9, b = Math.floor(r / 3) * 3 + Math.floor(cc / 3);
                if (i === idx) {
                    c.classList.add('error-strong');
                    return;
                }
                if (r === row || cc === col || b === box) {
                    c.classList.add('error-peer');
                }
            });
            livesEl.classList.remove('hit');
            void livesEl.offsetWidth;
            livesEl.classList.add('hit');
            setTimeout(() => {
                Array.from(gridEl.children).forEach(c => c.classList.remove('error-strong', 'error-peer'));
                livesEl.classList.remove('hit');
            }, 650);
        }

        function getUnitIndices(idx) {
            const row = Math.floor(idx / 9);
            const col = idx % 9;
            const boxRow = Math.floor(row / 3) * 3;
            const boxCol = Math.floor(col / 3) * 3;

            const rowIndices = Array.from({ length: 9 }, (_, i) => row * 9 + i);
            const colIndices = Array.from({ length: 9 }, (_, i) => i * 9 + col);
            const boxIndices = [];
            for (let r = boxRow; r < boxRow + 3; r++) {
                for (let c = boxCol; c < boxCol + 3; c++) {
                    boxIndices.push(r * 9 + c);
                }
            }
            return { rowIndices, colIndices, boxIndices };
        }

        function isUnitComplete(indices) {
            return indices.every(i => cellsData[i].value !== 0);
        }

        function celebrateCompletedUnits(idx, beforeState) {
            const { rowIndices, colIndices, boxIndices } = getUnitIndices(idx);
            const afterRow = isUnitComplete(rowIndices);
            const afterCol = isUnitComplete(colIndices);
            const afterBox = isUnitComplete(boxIndices);

            const justCompletedRow = !beforeState.row && afterRow;
            const justCompletedCol = !beforeState.col && afterCol;
            const justCompletedBox = !beforeState.box && afterBox;

            if (!justCompletedRow && !justCompletedCol && !justCompletedBox) return;

            const flashSet = new Set();
            if (justCompletedRow) rowIndices.forEach(i => flashSet.add(i));
            if (justCompletedCol) colIndices.forEach(i => flashSet.add(i));
            if (justCompletedBox) boxIndices.forEach(i => flashSet.add(i));

            flashSet.forEach(i => gridEl.children[i].classList.add('unit-complete'));
            setTimeout(() => {
                flashSet.forEach(i => gridEl.children[i].classList.remove('unit-complete'));
            }, 560);

            const parts = [];
            if (justCompletedRow) parts.push('一列');
            if (justCompletedCol) parts.push('一欄');
            if (justCompletedBox) parts.push('一宮');
            showFeedback(`完成 ${parts.join(' + ')}！`);
        }

        function handleInput(num) {
            if (selectedIdx === null || cellsData[selectedIdx].fixed || errors >= maxErrors) return;

            let data = cellsData[selectedIdx];
            const cellEl = gridEl.children[selectedIdx];

            if (isNotesMode) {
                if (data.value !== 0) return;
                const ni = data.notes.indexOf(num);
                if (ni > -1) data.notes.splice(ni, 1);
                else data.notes.push(num);
                recordAction('note', `${cellLabel(selectedIdx)} 候選 ${num}${ni > -1 ? ' 取消' : ' 加入'}`);
            } else {
                if (num !== currentLevel.solution[selectedIdx]) {
                    errors++;
                    updateLivesUI();
                    data.isError = true;
                    cellEl.classList.add('error');
                    const originalValue = data.value;
                    const originalNotes = data.notes.slice();
                    data.value = num;
                    data.notes = [];
                    cellEl.classList.add('wrong-preview');
                    updateCellDisplay(cellEl, data);
                    markErrorArea(selectedIdx);
                    showFeedback(`錯誤！${3 - errors} 次機會剩餘`);
                    playErrorFeedback();
                    recordAction('mistake', `${cellLabel(selectedIdx)} 輸入 ${num}（錯誤）`);
                    setTimeout(() => {
                        data.isError = false;
                        cellEl.classList.remove('error');
                        cellEl.classList.remove('wrong-preview');
                        data.value = originalValue;
                        data.notes = originalNotes;
                        updateCellDisplay(cellEl, data);
                    }, 400);
                    saveGameStatus();
                    if (errors >= maxErrors) showGameOver();
                    return;
                }
                const { rowIndices, colIndices, boxIndices } = getUnitIndices(selectedIdx);
                const beforeState = {
                    row: isUnitComplete(rowIndices),
                    col: isUnitComplete(colIndices),
                    box: isUnitComplete(boxIndices),
                };
                data.value = num;
                data.notes = [];
                data.isError = false;
                recordAction('fill', `${cellLabel(selectedIdx)} 填入 ${num}`);
                celebrateCompletedUnits(selectedIdx, beforeState);
                checkWin();
            }
            updateCellDisplay(cellEl, data);
            saveGameStatus();
            updateNumpadState();
        }

        function checkWin() {
            const isComplete = cellsData.every((data, i) => data.value === currentLevel.solution[i]);
            if (isComplete) {
                clearInterval(timerInterval);
                clearGameStatus(currentLevel.id);
                const earnedStars = saveProgress();
                showWinCelebration(earnedStars);
                submitFirstClear(currentLevel.id, seconds, earnedStars).then(() => {
                    loadLevelLeaderboard(currentLevel.id);
                });
            }
        }

        function createConfettiBurst(count = 50) {
            confettiLayerEl.innerHTML = '';
            const colors = ['#0984E3', '#74B9FF', '#F1C40F', '#00B894', '#6C5CE7'];
            for (let i = 0; i < count; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti';
                piece.style.left = `${Math.random() * 100}%`;
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDuration = `${2.1 + Math.random() * 1.3}s`;
                piece.style.animationDelay = `${Math.random() * 0.4}s`;
                piece.style.transform = `translateY(-20px) rotate(${Math.random() * 180}deg)`;
                confettiLayerEl.appendChild(piece);
            }
        }

        function showWinCelebration(earnedStars) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('win-level-name').textContent = currentLevel.displayName;
            document.getElementById('win-time').textContent = `${mins}:${secs}`;
            document.getElementById('win-stars').textContent = '★'.repeat(earnedStars) + '☆'.repeat(3 - earnedStars);
            createConfettiBurst(56);
            winCelebrationEl.style.display = 'flex';
            showFeedback('完成！太棒了！');
            if (navigator.vibrate) navigator.vibrate([90, 40, 90]);
        }

        function saveProgress() {
            const records = JSON.parse(localStorage.getItem('sudoku_records') || '{}');
            const existing = records[currentLevel.id];

            // 計算星數 (0錯=3星, 1錯=2星, 2錯=1星)
            const earnedStars = Math.max(1, 3 - errors);

            // 檢查是否更新紀錄（以星數優先，其次是時間）
            const shouldUpdate = !existing ||
                earnedStars > (existing.stars || 1) ||
                (earnedStars === (existing.stars || 1) && seconds < (existing.time || Infinity));

            if (shouldUpdate) {
                records[currentLevel.id] = {
                    time: seconds,
                    stars: earnedStars
                };
                localStorage.setItem('sudoku_records', JSON.stringify(records));
            }
            return earnedStars;
        }

        function updateLivesUI() {
            let html = '';
            for (let i = 0; i < maxErrors; i++) {
                html += `<span class="${i < errors ? 'lost' : ''}">✖</span> `;
            }
            livesEl.innerHTML = html;
        }

        function showGameOver() {
            clearInterval(timerInterval);
            overlay.style.display = 'flex';
        }

        function resetGame() {
            if (confirm('確定要重新開始本關嗎？當前進度將遺失。')) {
                clearGameStatus(currentLevel.id);
                initGame(currentLevel.id, true);
            }
        }

        let currentTab = 0;

        function showLevelScreen() {
            document.getElementById('pause-screen').style.display = 'none';
            document.querySelector('.game-container').style.display = 'none';
            clearInterval(timerInterval);
            overlay.style.display = 'none';
            closeReplayModal();
            document.getElementById('level-screen').style.display = 'flex';
            switchTab(currentTab);
        }

        function switchTab(tab) {
            currentTab = tab;
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach((b, i) => b.classList.toggle('active', i === tab));
            renderLevelGrid();
        }

        function renderLevelGrid() {
            const records = JSON.parse(localStorage.getItem('sudoku_records') || '{}');
            const list = document.getElementById('level-list');
            list.innerHTML = '';

            const filtered = levels.filter(l => l.stars === currentTab);
            filtered.forEach((l, index) => {
                const record = records[l.id];
                // 向下相容：處理舊的數字格式
                let bestTime = null;
                let bestStars = 0;
                if (record) {
                    if (typeof record === 'number') {
                        // 舊格式：僅紀錄時間
                        bestTime = record;
                        bestStars = 1;
                    } else {
                        bestTime = record.time;
                        bestStars = record.stars || 1;
                    }
                }

                const item = document.createElement('div');
                item.className = `level-item ${bestTime !== null ? 'completed' : ''}`;
                item.onclick = () => {
                    document.getElementById('level-screen').style.display = 'none';
                    initGame(l.id);
                };

                const timeStr = bestTime !== null ? `${Math.floor(bestTime / 60)}:${(bestTime % 60).toString().padStart(2, '0')}` : '';
                const starsHtml = bestStars > 0 ?
                    '<div class="level-stars">' + '★'.repeat(bestStars) + '<span class="empty-star">' + '☆'.repeat(3 - bestStars) + '</span></div>' : '';

                item.innerHTML = `
                    <div class="level-num">${l.displayName}</div>
                    ${starsHtml}
                    <div class="level-stats">${timeStr}</div>
                `;
                list.appendChild(item);
            });
        }

        function selectCell(idx) {
            selectedIdx = idx;
            const selectedVal = cellsData[idx].value;
            const row = Math.floor(idx / 9), col = idx % 9;
            const box = Math.floor(row / 3) * 3 + Math.floor(col / 3);

            Array.from(gridEl.children).forEach((c, i) => {
                c.classList.remove('selected', 'related', 'match');
                const r = Math.floor(i / 9), l = i % 9, b = Math.floor(r / 3) * 3 + Math.floor(l / 3);
                const val = cellsData[i].value;

                if (i === idx) {
                    c.classList.add('selected');
                } else {
                    if (r === row || l === col || b === box) {
                        c.classList.add('related');
                    }
                    if (selectedVal !== 0 && val === selectedVal) {
                        c.classList.add('match');
                    }
                }
            });
        }

        function toggleNoteMode() {
            isNotesMode = !isNotesMode;
            document.getElementById('note-toggle').classList.toggle('active', isNotesMode);
        }

        function toggleTheme() {
            const html = document.documentElement;
            const next = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('sudoku_theme', next);
        }

        function erase() {
            if (selectedIdx !== null && !cellsData[selectedIdx].fixed) {
                const oldVal = cellsData[selectedIdx].value;
                const oldNotes = cellsData[selectedIdx].notes.slice();
                cellsData[selectedIdx].value = 0;
                cellsData[selectedIdx].notes = [];
                updateCellDisplay(gridEl.children[selectedIdx], cellsData[selectedIdx]);
                if (oldVal !== 0 || oldNotes.length) {
                    recordAction('erase', `${cellLabel(selectedIdx)} 清除`);
                }
                saveGameStatus();
                updateNumpadState();
            }
        }

        function applyQuickNote(num) {
            if (selectedIdx === null || cellsData[selectedIdx].fixed || errors >= maxErrors) return;
            const data = cellsData[selectedIdx];
            if (data.value !== 0) {
                showFeedback('此格已有數字，無法填註');
                return;
            }
            const ni = data.notes.indexOf(num);
            if (ni > -1) data.notes.splice(ni, 1);
            else data.notes.push(num);
            updateCellDisplay(gridEl.children[selectedIdx], data);
            recordAction('quick_note', `${cellLabel(selectedIdx)} 長按候選 ${num}${ni > -1 ? ' 取消' : ' 加入'}`);
            showFeedback(`候選 ${num}${ni > -1 ? ' 已取消' : ' 已加入'}`);
            saveGameStatus();
        }

        function updateNumpadState() {
            if (!numButtons.length || !cellsData.length) return;
            const counts = new Array(10).fill(0);
            for (const c of cellsData) {
                if (c.value >= 1 && c.value <= 9) counts[c.value] += 1;
            }
            const beginnerOnlyCompleted = !!currentLevel && currentLevel.stars === 0;
            numButtons.forEach((btn, i) => {
                const n = i + 1;
                btn.classList.toggle('completed', beginnerOnlyCompleted && counts[n] >= 9);
            });
        }

        function bindNumButtonEvents(btn, num) {
            let pressTimer = null;
            let longPressed = false;
            const LONG_MS = 320;

            const startPress = (ev) => {
                if (ev && ev.button !== undefined && ev.button !== 0) return;
                longPressed = false;
                clearTimeout(pressTimer);
                btn.classList.add('long-pressing');
                pressTimer = setTimeout(() => {
                    longPressed = true;
                    btn.classList.remove('long-pressing');
                    applyQuickNote(num);
                }, LONG_MS);
            };

            const endPress = () => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                btn.classList.remove('long-pressing');
                if (!longPressed) handleInput(num);
                longPressed = false;
            };

            const cancelPress = () => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                btn.classList.remove('long-pressing');
                longPressed = false;
            };

            btn.addEventListener('pointerdown', startPress);
            btn.addEventListener('pointerup', endPress);
            btn.addEventListener('pointercancel', cancelPress);
            btn.addEventListener('pointerleave', cancelPress);
            btn.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        const np = document.getElementById('numpad');
        for (let i = 1; i <= 9; i++) {
            const b = document.createElement('button');
            b.className = 'num-btn';
            b.textContent = i;
            bindNumButtonEvents(b, i);
            numButtons.push(b);
            np.appendChild(b);
        }

        window.addEventListener('keydown', (e) => {
            if (e.key >= 1 && e.key <= 9) handleInput(parseInt(e.key));
            if (e.key === 'Backspace') erase();
        });

        // Init Theme
        const savedTheme = localStorage.getItem('sudoku_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        const APP_VERSION = '2026.02.06.2';
        document.getElementById('version-badge').textContent = `v${APP_VERSION}`;
        function enforceAppVersion() {
            const key = 'sudoku_app_version';
            const stored = localStorage.getItem(key);
            if (stored === APP_VERSION) return false;
            localStorage.setItem(key, APP_VERSION);
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations()
                    .then((regs) => Promise.all(regs.map((r) => r.unregister())))
                    .catch(() => {});
            }
            if ('caches' in window) {
                caches.keys()
                    .then((keys) => Promise.all(keys.map((k) => caches.delete(k))))
                    .finally(() => window.location.reload());
            } else {
                window.location.reload();
            }
            return true;
        }
        enforceAppVersion();

        // Initialize with Auto-Update Notification
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                // 當發現有新的 Service Worker 時觸發
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        // 當新 Service Worker 安裝完成，且頁面目前已有 Controller (代表不是第一次造訪)
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // 使用系統原生對話框或自定義 UI 通知使用者
                            if (confirm('發現新的版本與關卡！是否立即更新以體驗最新內容？')) {
                                window.location.reload();
                            }
                        }
                    };
                };
            }).catch(err => console.error('SW init fail:', err));
        }
        initFirebase();
        loadAliasToInput();
        if (aliasInputEl) {
            aliasInputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveAlias();
            });
        }
        if (replayModalEl) {
            replayModalEl.addEventListener('click', (e) => {
                if (e.target === replayModalEl) closeReplayModal();
            });
        }
        showLevelScreen();
    </script>
</body>

</html>
